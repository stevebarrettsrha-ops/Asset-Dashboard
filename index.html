<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Asset Management Dashboard - May Pen Hospital</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-orange: #FF6B35;
            --dark-orange: #E55934;
            --light-orange: #FFA559;
            --primary-green: #2ECC71;
            --dark-green: #27AE60;
            --light-green: #58D68D;
            --dark-gray: #2C3E50;
            --light-gray: #ECF0F1;
            --white: #FFFFFF;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
            color: var(--dark-gray);
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Section */
        .header {
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--dark-orange) 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 40%;
            height: 200%;
            background: rgba(255, 255, 255, 0.05);
            transform: rotate(35deg);
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .dashboard-title {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .dashboard-subtitle {
            font-size: 1.1em;
            opacity: 0.95;
            margin-bottom: 25px;
        }

        /* Status Bar */
        .status-bar {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: var(--light-green);
        }

        .status-indicator.error {
            background: #ff4444;
        }

        .status-indicator.loading {
            background: #ffa500;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .refresh-btn {
            background: white;
            color: var(--primary-orange);
            padding: 10px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* Configuration Section */
        .config-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 30px;
        }

        .config-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .config-label {
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9em;
        }

        .config-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.1);
        }

        .config-help {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .config-btn {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        .config-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
        }

        /* Search Section */
        .search-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 30px;
        }

        .search-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.1);
        }

        .search-btn {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.3);
        }

        .clear-btn {
            background: #6c757d;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* KPI Cards */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px var(--shadow);
        }

        .kpi-card.orange {
            border-left: 5px solid var(--primary-orange);
        }

        .kpi-card.green {
            border-left: 5px solid var(--primary-green);
        }

        .kpi-label {
            font-size: 0.9em;
            color: #7f8c8d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 2.2em;
            font-weight: 700;
            margin: 10px 0;
        }

        .kpi-value.orange {
            color: var(--primary-orange);
        }

        .kpi-value.green {
            color: var(--primary-green);
        }

        .kpi-subtitle {
            font-size: 0.85em;
            color: #95a5a6;
        }

        /* Charts */
        .chart-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark-gray);
        }

        /* Data Table */
        .data-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .toggle-btn {
            padding: 8px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--dark-orange) 100%);
            color: white;
            border-color: var(--primary-orange);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
        }

        th {
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        td {
            padding: 12px;
            font-size: 0.95em;
        }

        .asset-code {
            font-weight: 600;
            color: var(--primary-orange);
        }

        .item-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .item-type-badge.medical {
            background: rgba(46, 204, 113, 0.1);
            color: var(--dark-green);
        }

        .item-type-badge.furniture {
            background: rgba(255, 107, 53, 0.1);
            color: var(--dark-orange);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: #95a5a6;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-gray);
            border-top-color: var(--primary-orange);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Export Button */
        .export-btn {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.3);
            transition: all 0.3s;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(46, 204, 113, 0.4);
        }

        /* Instructions */
        .instructions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .instructions ol {
            color: #856404;
            margin-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
        }

        .instructions a {
            color: #0066cc;
            text-decoration: none;
        }

        .instructions a:hover {
            text-decoration: underline;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .last-update {
            background: var(--light-gray);
            padding: 10px;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1 class="dashboard-title">Fixed Asset Management Dashboard</h1>
                <div class="dashboard-subtitle">May Pen Hospital ‚Ä¢ Live Data from Google Sheets</div>
                
                <div class="status-bar">
                    <div class="status-item">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span id="statusText">Ready to connect</span>
                    </div>
                    <div class="status-item">
                        <span id="lastUpdateText">Not loaded yet</span>
                    </div>
                    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
                </div>
            </div>
        </div>

        <!-- Instructions (shown initially) -->
        <div class="instructions" id="setupInstructions">
            <h3>‚öôÔ∏è Quick Setup Instructions</h3>
            <ol>
                <li><strong>Convert to Google Sheets:</strong>
                    <ul>
                        <li>Upload your Excel files to Google Drive</li>
                        <li>Right-click each ‚Üí "Open with" ‚Üí "Google Sheets"</li>
                    </ul>
                </li>
                <li><strong>Make Sheets Public:</strong>
                    <ul>
                        <li>Click "Share" button in each sheet</li>
                        <li>Change to "Anyone with the link can view"</li>
                        <li>Copy the sharing link</li>
                    </ul>
                </li>
                <li><strong>Paste Sheet IDs below:</strong>
                    <ul>
                        <li>The ID is the long string in the URL between /d/ and /edit</li>
                        <li>Example: docs.google.com/spreadsheets/d/<strong>ABC123xyz</strong>/edit</li>
                    </ul>
                </li>
                <li><strong>Save and Load:</strong> Click "Save & Load Data" button</li>
            </ol>
            <p style="margin-top: 15px; color: #856404;">
                <strong>GitHub Hosting:</strong> After setup, this file can be hosted on GitHub Pages for access from anywhere!
            </p>
        </div>

        <!-- Configuration -->
        <div class="config-section">
            <h2 class="config-title">
                <span>üìä</span>
                Google Sheets Configuration
            </h2>
            <div class="config-grid">
                <div class="config-item">
                    <label class="config-label">Purchased Assets Sheet ID:</label>
                    <input type="text" 
                           id="purchasedSheetId" 
                           class="config-input" 
                           placeholder="Enter Google Sheets ID (e.g., 1ABC123xyz...)"
                           value="">
                    <span class="config-help">From: docs.google.com/spreadsheets/d/[THIS_PART]/edit</span>
                </div>
                <div class="config-item">
                    <label class="config-label">Donated Assets Sheet ID:</label>
                    <input type="text" 
                           id="donatedSheetId" 
                           class="config-input" 
                           placeholder="Enter Google Sheets ID (e.g., 1DEF456abc...)"
                           value="">
                    <span class="config-help">From: docs.google.com/spreadsheets/d/[THIS_PART]/edit</span>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="config-btn" onclick="saveAndLoad()">üíæ Save & Load Data</button>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <h2 class="search-title">
                <span>üîç</span>
                Asset Search Engine
            </h2>
            <div class="search-container">
                <input type="text" 
                       id="assetCodeSearch" 
                       class="search-input" 
                       placeholder="Enter Asset Code (e.g., 1, 2, 3...)">
                <input type="text" 
                       id="descriptionSearch" 
                       class="search-input" 
                       placeholder="Search by Description">
                <input type="text" 
                       id="serialSearch" 
                       class="search-input" 
                       placeholder="Search by Serial/Model">
                <button class="search-btn" onclick="performSearch()">Search</button>
                <button class="clear-btn" onclick="clearSearch()">Clear</button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-section" id="kpiSection"></div>

        <!-- Charts -->
        <div class="chart-section">
            <div class="chart-card">
                <h3 class="chart-title">Asset Distribution</h3>
                <canvas id="distributionChart" height="300"></canvas>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Monthly Asset Value Trend</h3>
                <canvas id="monthlyChart" height="300"></canvas>
            </div>
        </div>

        <!-- Data Table -->
        <div class="data-section">
            <div class="section-header">
                <h2 class="section-title">Asset Inventory</h2>
                <div class="view-toggle">
                    <button class="toggle-btn active" onclick="switchView('all', this)">All Assets</button>
                    <button class="toggle-btn" onclick="switchView('purchased', this)">Purchased</button>
                    <button class="toggle-btn" onclick="switchView('donated', this)">Donated</button>
                </div>
            </div>
            <div class="table-container" id="tableContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Configure Google Sheets above to load data</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="last-update" id="lastUpdate">
                Auto-refresh enabled ‚Ä¢ Updates every 5 minutes when configured
            </div>
            <p style="margin-top: 10px;">Fixed Asset Management System ¬© 2024</p>
        </div>
    </div>

    <!-- Export Button -->
    <button class="export-btn" onclick="exportData()">üì• Export Report</button>

    <script>
        // Global Variables
        let purchasedData = {};
        let donatedData = {};
        let allAssetsData = [];
        let filteredData = [];
        let currentView = 'all';
        let distributionChart = null;
        let monthlyChart = null;
        let autoRefreshInterval = null;
        const months = ['APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC', 'JAN', 'FEB', 'MAR'];

        // Initialize on load
        window.onload = function() {
            loadConfiguration();
            initializeCharts();
            
            // Auto-load if configuration exists
            const purchasedId = localStorage.getItem('purchasedSheetId');
            const donatedId = localStorage.getItem('donatedSheetId');
            if (purchasedId && donatedId) {
                document.getElementById('setupInstructions').style.display = 'none';
                loadData();
            }
        };

        // Load saved configuration
        function loadConfiguration() {
            const purchasedId = localStorage.getItem('purchasedSheetId');
            const donatedId = localStorage.getItem('donatedSheetId');
            
            if (purchasedId) document.getElementById('purchasedSheetId').value = purchasedId;
            if (donatedId) document.getElementById('donatedSheetId').value = donatedId;
        }

        // Save configuration and load data
        function saveAndLoad() {
            const purchasedId = extractSheetId(document.getElementById('purchasedSheetId').value);
            const donatedId = extractSheetId(document.getElementById('donatedSheetId').value);
            
            if (!purchasedId || !donatedId) {
                alert('Please enter both Google Sheets IDs');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('purchasedSheetId', purchasedId);
            localStorage.setItem('donatedSheetId', donatedId);
            
            // Hide instructions
            document.getElementById('setupInstructions').style.display = 'none';
            
            // Load data
            loadData();
        }

        // Extract Sheet ID from URL or return as-is
        function extractSheetId(input) {
            if (!input) return null;
            
            // Check if it's a Google Sheets URL
            const match = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            if (match) return match[1];
            
            // Assume it's already an ID
            return input.trim();
        }

        // Load data from Google Sheets
        async function loadData() {
            const purchasedId = localStorage.getItem('purchasedSheetId');
            const donatedId = localStorage.getItem('donatedSheetId');
            
            if (!purchasedId || !donatedId) {
                alert('Please configure Google Sheets IDs first');
                return;
            }
            
            updateStatus('loading', 'Loading data from Google Sheets...');
            
            try {
                // Construct export URLs for public Google Sheets
                const purchasedUrl = `https://docs.google.com/spreadsheets/d/${purchasedId}/export?format=xlsx`;
                const donatedUrl = `https://docs.google.com/spreadsheets/d/${donatedId}/export?format=xlsx`;
                
                // Create a proxy URL if needed (for CORS issues)
                // Note: You might need to use a CORS proxy service
                const corsProxy = 'https://cors-anywhere.herokuapp.com/';
                
                // Try direct fetch first
                let purchasedResponse, donatedResponse;
                
                try {
                    // Direct fetch
                    purchasedResponse = await fetch(purchasedUrl);
                    donatedResponse = await fetch(donatedUrl);
                } catch (corsError) {
                    // If CORS error, try with proxy
                    console.log('Direct fetch failed, trying with CORS proxy...');
                    purchasedResponse = await fetch(corsProxy + purchasedUrl);
                    donatedResponse = await fetch(corsProxy + donatedUrl);
                }
                
                if (!purchasedResponse.ok || !donatedResponse.ok) {
                    throw new Error('Failed to fetch sheets. Make sure they are publicly accessible.');
                }
                
                // Process the data
                const purchasedBlob = await purchasedResponse.blob();
                const donatedBlob = await donatedResponse.blob();
                
                const purchasedArrayBuffer = await purchasedBlob.arrayBuffer();
                const donatedArrayBuffer = await donatedBlob.arrayBuffer();
                
                const purchasedWorkbook = XLSX.read(purchasedArrayBuffer, { type: 'array' });
                const donatedWorkbook = XLSX.read(donatedArrayBuffer, { type: 'array' });
                
                purchasedData = processWorkbook(purchasedWorkbook, 'Purchased');
                donatedData = processWorkbook(donatedWorkbook, 'Donated');
                
                // Combine and display
                combineAndDisplayData();
                updateCharts();
                
                // Update status
                updateStatus('connected', 'Data loaded successfully');
                document.getElementById('lastUpdateText').textContent = `Last updated: ${new Date().toLocaleString()}`;
                
                // Setup auto-refresh
                setupAutoRefresh();
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateStatus('error', 'Error loading data');
                
                // Show helpful error message
                alert(`Error loading data. Please ensure:
                
1. Both Excel files are converted to Google Sheets
2. Both sheets are set to "Anyone with the link can view"
3. The Sheet IDs are correct
4. Try refreshing the page

If you continue to have issues, you may need to:
- Enable CORS proxy (visit https://cors-anywhere.herokuapp.com/corsdemo)
- Or download and host this file on GitHub Pages`);
            }
        }

        // Process workbook data
        function processWorkbook(workbook, sourceType) {
            const processedData = {
                monthly: {},
                allItems: [],
                totals: {
                    totalValue: 0,
                    totalItems: 0,
                    medicalEquipment: 0,
                    medicalValue: 0,
                    furniture: 0,
                    furnitureValue: 0
                }
            };
            
            months.forEach(month => {
                if (workbook.Sheets[month]) {
                    const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[month], { 
                        header: 1, 
                        raw: false, 
                        dateNF: 'yyyy-mm-dd' 
                    });
                    const monthData = processMonthData(sheetData, month, sourceType);
                    processedData.monthly[month] = monthData;
                    processedData.allItems = processedData.allItems.concat(monthData.items);
                    
                    processedData.totals.totalItems += monthData.stats.totalItems;
                    processedData.totals.totalValue += monthData.stats.totalValue;
                    processedData.totals.medicalEquipment += monthData.stats.medicalEquipment;
                    processedData.totals.medicalValue += monthData.stats.medicalValue;
                    processedData.totals.furniture += monthData.stats.furniture;
                    processedData.totals.furnitureValue += monthData.stats.furnitureValue;
                }
            });
            
            return processedData;
        }

        // Process monthly data
        function processMonthData(rawData, month, sourceType) {
            let headerRowIndex = -1;
            let headers = [];
            
            // Find header row
            for (let i = 0; i < Math.min(15, rawData.length); i++) {
                if (rawData[i] && rawData[i][0] && 
                    (rawData[i][0].toString().toLowerCase().includes('date') || 
                     (rawData[i][1] && rawData[i][1].toString().toLowerCase().includes('date')))) {
                    headerRowIndex = i;
                    headers = rawData[i];
                    break;
                }
            }
            
            if (headerRowIndex === -1) {
                return { items: [], stats: { totalItems: 0, totalValue: 0, medicalEquipment: 0, medicalValue: 0, furniture: 0, furnitureValue: 0 } };
            }
            
            const items = [];
            let stats = {
                totalItems: 0,
                totalValue: 0,
                medicalEquipment: 0,
                medicalValue: 0,
                furniture: 0,
                furnitureValue: 0
            };
            
            for (let i = headerRowIndex + 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row && row[0] && !isNaN(row[0]) && row[3]) {
                    const price = parseFloat(row[9]) || 0;
                    const quantity = parseInt(row[2]) || 1;
                    const totalPrice = price * quantity;
                    const itemType = row[6] ? row[6].toString() : '';
                    const isMedical = itemType.toLowerCase().includes('medical');
                    
                    const item = {
                        assetCode: row[0].toString(),
                        dateIn: row[1] || '',
                        quantity: quantity,
                        description: row[3] || '',
                        supplier: row[4] || '',
                        itemType: row[5] || sourceType,
                        category: isMedical ? 'Medical Equipment' : 'Furniture & Appliances',
                        serialModel: row[7] || '',
                        unitPrice: price,
                        totalPrice: totalPrice,
                        source: sourceType,
                        month: month
                    };
                    
                    items.push(item);
                    stats.totalItems++;
                    stats.totalValue += totalPrice;
                    
                    if (isMedical) {
                        stats.medicalEquipment++;
                        stats.medicalValue += totalPrice;
                    } else {
                        stats.furniture++;
                        stats.furnitureValue += totalPrice;
                    }
                }
            }
            
            return { items, stats };
        }

        // Combine and display data
        function combineAndDisplayData() {
            allAssetsData = [];
            
            if (purchasedData.allItems) {
                allAssetsData = allAssetsData.concat(purchasedData.allItems);
            }
            if (donatedData.allItems) {
                allAssetsData = allAssetsData.concat(donatedData.allItems);
            }
            
            filteredData = allAssetsData;
            updateKPICards();
            displayTable();
        }

        // Update KPI Cards
        function updateKPICards() {
            const kpiSection = document.getElementById('kpiSection');
            
            const totalItems = (purchasedData.totals?.totalItems || 0) + (donatedData.totals?.totalItems || 0);
            const totalValue = (purchasedData.totals?.totalValue || 0) + (donatedData.totals?.totalValue || 0);
            const medicalItems = (purchasedData.totals?.medicalEquipment || 0) + (donatedData.totals?.medicalEquipment || 0);
            const medicalValue = (purchasedData.totals?.medicalValue || 0) + (donatedData.totals?.medicalValue || 0);
            const furnitureItems = (purchasedData.totals?.furniture || 0) + (donatedData.totals?.furniture || 0);
            const furnitureValue = (purchasedData.totals?.furnitureValue || 0) + (donatedData.totals?.furnitureValue || 0);
            
            kpiSection.innerHTML = `
                <div class="kpi-card green">
                    <div class="kpi-label">Total Assets</div>
                    <div class="kpi-value green">${totalItems.toLocaleString()}</div>
                    <div class="kpi-subtitle">All inventory items</div>
                </div>
                
                <div class="kpi-card orange">
                    <div class="kpi-label">Total Value</div>
                    <div class="kpi-value orange">$${formatCurrency(totalValue)}</div>
                    <div class="kpi-subtitle">Combined asset value</div>
                </div>
                
                <div class="kpi-card green">
                    <div class="kpi-label">Medical Equipment</div>
                    <div class="kpi-value green">${medicalItems.toLocaleString()}</div>
                    <div class="kpi-subtitle">Value: $${formatCurrency(medicalValue)}</div>
                </div>
                
                <div class="kpi-card orange">
                    <div class="kpi-label">Furniture & Appliances</div>
                    <div class="kpi-value orange">${furnitureItems.toLocaleString()}</div>
                    <div class="kpi-subtitle">Value: $${formatCurrency(furnitureValue)}</div>
                </div>
                
                <div class="kpi-card green">
                    <div class="kpi-label">Purchased Assets</div>
                    <div class="kpi-value green">${(purchasedData.totals?.totalItems || 0).toLocaleString()}</div>
                    <div class="kpi-subtitle">Value: $${formatCurrency(purchasedData.totals?.totalValue || 0)}</div>
                </div>
                
                <div class="kpi-card orange">
                    <div class="kpi-label">Donated Assets</div>
                    <div class="kpi-value orange">${(donatedData.totals?.totalItems || 0).toLocaleString()}</div>
                    <div class="kpi-subtitle">Value: $${formatCurrency(donatedData.totals?.totalValue || 0)}</div>
                </div>
            `;
        }

        // Initialize Charts
        function initializeCharts() {
            const ctx1 = document.getElementById('distributionChart').getContext('2d');
            const ctx2 = document.getElementById('monthlyChart').getContext('2d');
            
            distributionChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Medical Equipment', 'Furniture & Appliances'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#2ECC71', '#FF6B35'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            monthlyChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Purchased Assets',
                        data: new Array(12).fill(0),
                        borderColor: '#2ECC71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        borderWidth: 3,
                        tension: 0.4
                    }, {
                        label: 'Donated Assets',
                        data: new Array(12).fill(0),
                        borderColor: '#FF6B35',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        borderWidth: 3,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Update Charts
        function updateCharts() {
            const medicalCount = (purchasedData.totals?.medicalEquipment || 0) + (donatedData.totals?.medicalEquipment || 0);
            const furnitureCount = (purchasedData.totals?.furniture || 0) + (donatedData.totals?.furniture || 0);
            
            // Update distribution chart
            distributionChart.data.datasets[0].data = [medicalCount, furnitureCount];
            distributionChart.update();
            
            // Update monthly chart
            const purchasedMonthlyValues = months.map(month => 
                purchasedData.monthly?.[month]?.stats?.totalValue || 0
            );
            const donatedMonthlyValues = months.map(month => 
                donatedData.monthly?.[month]?.stats?.totalValue || 0
            );
            
            monthlyChart.data.datasets[0].data = purchasedMonthlyValues;
            monthlyChart.data.datasets[1].data = donatedMonthlyValues;
            monthlyChart.update();
        }

        // Display table
        function displayTable() {
            const container = document.getElementById('tableContainer');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="loading">No data to display</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Asset Code</th>
                            <th>Date In</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Supplier/Donor</th>
                            <th>Source</th>
                            <th>Serial/Model</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total Value</th>
                            <th>Month</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredData.forEach(item => {
                const categoryBadge = item.category === 'Medical Equipment' 
                    ? '<span class="item-type-badge medical">Medical</span>'
                    : '<span class="item-type-badge furniture">Furniture</span>';
                
                html += `
                    <tr>
                        <td><span class="asset-code">${item.assetCode}</span></td>
                        <td>${item.dateIn}</td>
                        <td>${item.description}</td>
                        <td>${categoryBadge}</td>
                        <td>${item.supplier}</td>
                        <td>${item.source}</td>
                        <td>${item.serialModel}</td>
                        <td>${item.quantity}</td>
                        <td>$${formatCurrency(item.unitPrice)}</td>
                        <td><strong>$${formatCurrency(item.totalPrice)}</strong></td>
                        <td>${item.month}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Search functions
        function performSearch() {
            const assetCode = document.getElementById('assetCodeSearch').value.toLowerCase();
            const description = document.getElementById('descriptionSearch').value.toLowerCase();
            const serial = document.getElementById('serialSearch').value.toLowerCase();
            
            filteredData = allAssetsData.filter(item => {
                const matchAssetCode = !assetCode || item.assetCode.toLowerCase().includes(assetCode);
                const matchDescription = !description || item.description.toLowerCase().includes(description);
                const matchSerial = !serial || item.serialModel.toLowerCase().includes(serial);
                
                return matchAssetCode && matchDescription && matchSerial;
            });
            
            if (currentView !== 'all') {
                filteredData = filteredData.filter(item => 
                    currentView === 'purchased' ? item.source === 'Purchased' : item.source === 'Donated'
                );
            }
            
            displayTable();
        }

        function clearSearch() {
            document.getElementById('assetCodeSearch').value = '';
            document.getElementById('descriptionSearch').value = '';
            document.getElementById('serialSearch').value = '';
            filteredData = allAssetsData;
            displayTable();
        }

        function switchView(view, button) {
            currentView = view;
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            if (view === 'all') {
                filteredData = allAssetsData;
            } else {
                filteredData = allAssetsData.filter(item => 
                    view === 'purchased' ? item.source === 'Purchased' : item.source === 'Donated'
                );
            }
            
            displayTable();
        }

        // Utility functions
        function formatCurrency(value) {
            return value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = 'status-indicator ' + status;
            text.textContent = message;
        }

        function setupAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            // Auto-refresh every 5 minutes
            autoRefreshInterval = setInterval(loadData, 5 * 60 * 1000);
        }

        // Export function
        function exportData() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const headers = ['Asset Code', 'Date In', 'Description', 'Category', 'Supplier/Donor', 
                           'Source', 'Serial/Model', 'Quantity', 'Unit Price', 'Total Value', 'Month'];
            const rows = filteredData.map(item => [
                item.assetCode,
                item.dateIn,
                item.description,
                item.category,
                item.supplier,
                item.source,
                item.serialModel,
                item.quantity,
                item.unitPrice,
                item.totalPrice,
                item.month
            ]);
            
            const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            XLSX.utils.book_append_sheet(wb, ws, 'Assets');
            XLSX.writeFile(wb, `Asset_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
    </script>
</body>
</html>